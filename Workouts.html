<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Training Log</title>
  <style>
    :root{
      --card:#111826; --text:#e8eef7; --muted:#a7b3c6; --line:#243247; --accent:#7dd3fc;
      --danger:#fb7185; --ok:#34d399;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #070a0f, #0b0f14);
      color:var(--text);
    }
    .container{ max-width: 980px; margin: 0 auto; padding: 16px; }
    .card{
      background: rgba(17, 24, 38, 0.92);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      margin: 12px 0;
    }
    h1{ margin:0 0 6px; font-size: 22px; }
    p{ margin:0; color:var(--muted); }
    h2{ margin: 0 0 10px; font-size: 16px; }
    h3{ margin: 0; font-size: 14px; color: var(--muted); }

    label{ display:flex; flex-direction:column; gap:6px; color:var(--muted); font-size: 13px; }
    input, textarea, select{
      padding:10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0d1421;
      color: var(--text);
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }

    .grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .full{ grid-column: 1 / -1; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap; }
    .actions{ display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }

    button{
      border: 1px solid var(--line);
      background: #0d1421;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 800;
    }
    button:hover{ border-color: var(--accent); }
    .ok{ border-color: rgba(52,211,153,.55); }
    .ok:hover{ border-color: var(--ok); }
    .danger{ border-color: rgba(251,113,133,.6); }
    .danger:hover{ border-color: var(--danger); }
    .small{ padding: 8px 10px; font-weight: 900; }

    .exercise{
      border: 1px solid rgba(36,50,71,.7);
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      background: rgba(13, 20, 33, 0.85);
    }
    .exerciseHeader{ display:flex; gap:12px; align-items:flex-start; }
    .thumb{
      width: 92px; min-width: 92px; height: 72px;
      border-radius: 10px; border: 1px solid rgba(36,50,71,.7);
      background: rgba(7,10,15,.35);
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .thumb svg{ width: 92px; height: 72px; }
    .exerciseMeta{ flex:1; }
    .exerciseNameLine{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .pill{
      font-size: 12px; padding: 5px 8px;
      border: 1px solid rgba(36,50,71,.7);
      border-radius: 999px; color: var(--muted);
      background: rgba(7,10,15,.25);
    }
    .tips{ margin-top: 8px; color: var(--muted); font-size: 13px; line-height: 1.45; }
    .tips ul{ margin: 6px 0 0 18px; padding:0; }
    .tips li{ margin: 4px 0; }

    .sets{ margin-top: 10px; }
    .setRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 10px;
      align-items:end;
      padding: 10px;
      border: 1px solid rgba(36,50,71,.55);
      border-radius: 12px;
      margin-top: 10px;
      background: rgba(7,10,15,.25);
    }

    .compareGrid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; margin-top: 10px; }
    .compareCard{
      border: 1px solid rgba(36,50,71,.7);
      border-radius: 12px;
      padding: 10px;
      background: rgba(7,10,15,.25);
      font-size: 12px;
      line-height: 1.35;
    }
    .compareCard b{ display:block; margin-bottom: 4px; }
    .up{ color: rgba(52,211,153,.95); font-weight: 900; }
    .down{ color: rgba(251,113,133,.95); font-weight: 900; }
    .flat{ color: rgba(167,179,198,.95); font-weight: 900; }

    .hint{ color: var(--muted); font-size: 12px; margin-top: 8px; line-height: 1.4; }
    .warn{
      border-left: 3px solid rgba(125,211,252,.8);
      padding: 10px 12px;
      background: rgba(125,211,252,.06);
      border-radius: 10px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    #errorBanner{
      display:none;
      background: rgba(251,113,133,.14);
      border: 1px solid rgba(251,113,133,.55);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      margin: 12px 0;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    /* ---------- MOBILE FIX (iPhone) ---------- */
    @media (max-width: 520px){
      .container{ padding: 12px; }
      .grid{ grid-template-columns: 1fr !important; }
      .full{ grid-column: 1 / -1; }
      .row, .actions{ gap: 8px; }
      button{ width: 100%; }

      .exerciseHeader{ flex-direction: column; }
      .thumb{ width: 100%; min-width: 0; height: 90px; }
      .thumb svg{ width: 100%; height: 90px; }

      .setRow{ grid-template-columns: 1fr 1fr; align-items: stretch; }
      .setRow .removeSet{ grid-column: 1 / -1; width: 100%; }

      .compareGrid{ grid-template-columns: 1fr !important; }
      .pill{ font-size: 11px; }
      input, textarea, select{ padding: 10px; }
    }
    @media (min-width: 521px) and (max-width: 800px){
      .compareGrid{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="errorBanner"></div>

    <header class="card">
      <h1>Training Log</h1>
      <p>Kies Push / Pull / Benen → workout laadt automatisch → log je sets.</p>
      <div class="warn" style="margin-top:10px;">
        Let op iPhone: als je dit lokaal uit Bestanden opent kan JS/storage beperkt zijn. Een webpagina (https) werkt het meest stabiel.
      </div>
    </header>

    <section class="card">
      <h2>Nieuwe training</h2>

      <form id="sessionForm" class="grid">
        <label>
          Datum
          <input type="date" id="date" required />
        </label>

        <label>
          Training
          <select id="templateSelect">
            <option value="push">Push (borst/schouders/triceps)</option>
            <option value="pull">Pull (rug/biceps)</option>
            <option value="legs">Benen + core</option>
          </select>
        </label>

        <div class="full row">
          <div class="hint">Wissel training hierboven—de workout laadt direct. “Herlaad” zet ’m opnieuw.</div>
          <div class="row">
            <button type="button" id="reloadBtn" class="small">Herlaad workout</button>
            <button type="button" id="clearFormBtn" class="small danger">Form leegmaken</button>
          </div>
        </div>

        <label class="full">
          Notities (optioneel)
          <textarea id="sessionNotes" rows="2" placeholder="bv. energie 7/10, goede pump..."></textarea>
        </label>

        <div class="full" id="exercises"></div>

        <div class="actions full">
          <button type="submit" class="ok">Training opslaan</button>
          <button type="button" id="exportBtn">Export</button>
          <input type="file" id="importFile" accept="application/json" style="display:none;" />
          <button type="button" id="importBtn">Import</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Log (simpel)</h2>
      <div id="log" class="hint">Nog geen trainingen.</div>
    </section>
  </div>

  <template id="exerciseTemplate">
    <div class="exercise">
      <div class="exerciseHeader">
        <div class="thumb" data-thumb></div>
        <div class="exerciseMeta">
          <div class="row">
            <div class="exerciseNameLine">
              <strong data-title></strong>
              <span class="pill" data-muscles></span>
              <span class="pill" data-equipment></span>
            </div>
            <button type="button" class="danger small" data-remove>Verwijder</button>
          </div>

          <div class="tips" data-tips></div>
          <div class="tips" data-compare></div>

          <div class="row" style="margin-top:10px;">
            <h3>Sets</h3>
            <button type="button" class="small" data-addset>+ Set</button>
          </div>

          <div class="sets" data-sets></div>
        </div>
      </div>
    </div>
  </template>

  <template id="setTemplate">
    <div class="setRow">
      <label>Reps
        <input type="number" class="reps" min="0" step="1" placeholder="8" inputmode="numeric" />
      </label>
      <label>Gewicht (kg)
        <input type="number" class="weight" min="0" step="0.5" placeholder="20" inputmode="decimal" />
      </label>
      <label>RPE (opt.)
        <input type="number" class="rpe" min="0" max="10" step="0.5" placeholder="8" inputmode="decimal" />
      </label>
      <button type="button" class="danger small removeSet">X</button>
    </div>
  </template>

  <script>
    // Error banner
    const errorBanner = document.getElementById("errorBanner");
    window.addEventListener("error", (e) => {
      errorBanner.style.display = "block";
      errorBanner.textContent =
        "Er ging iets mis (JavaScript error):\n\n" +
        (e?.message || "Onbekende fout") +
        (e?.filename ? ("\n\nBestand: " + e.filename) : "") +
        (typeof e?.lineno === "number" ? ("\nRegel: " + e.lineno) : "");
    });

    const STORAGE_KEY = "training_sessions_full_v1_mobilefix";

    // DOM
    const sessionForm = document.getElementById("sessionForm");
    const dateEl = document.getElementById("date");
    const templateSelect = document.getElementById("templateSelect");
    const reloadBtn = document.getElementById("reloadBtn");
    const clearFormBtn = document.getElementById("clearFormBtn");
    const sessionNotesEl = document.getElementById("sessionNotes");
    const exercisesWrap = document.getElementById("exercises");

    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");
    const logEl = document.getElementById("log");

    const exerciseTemplate = document.getElementById("exerciseTemplate");
    const setTemplate = document.getElementById("setTemplate");

    // Utils
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function parseNum(v){
      if (v === "" || v === null || v === undefined) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function loadSessions(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        const data = raw ? JSON.parse(raw) : [];
        return Array.isArray(data) ? data : [];
      }catch{
        return [];
      }
    }
    function saveSessions(s){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    }
    function uuid(){
      return String(Date.now()) + "-" + Math.random().toString(16).slice(2);
    }

    // SVG thumbs (offline / simpel)
    const SVG = {
      bench: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="50" width="80" height="6" rx="3" fill="rgba(125,211,252,.35)"/><rect x="18" y="40" width="40" height="6" rx="3" fill="rgba(125,211,252,.55)"/><circle cx="60" cy="34" r="5" fill="rgba(232,238,247,.7)"/><rect x="44" y="18" width="32" height="4" rx="2" fill="rgba(232,238,247,.45)"/></svg>`,
      incline: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="52" width="72" height="6" rx="3" fill="rgba(125,211,252,.35)"/><rect x="24" y="26" width="42" height="6" rx="3" transform="rotate(18 24 26)" fill="rgba(125,211,252,.55)"/><circle cx="58" cy="30" r="5" fill="rgba(232,238,247,.7)"/></svg>`,
      press: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><circle cx="46" cy="20" r="6" fill="rgba(232,238,247,.7)"/><rect x="20" y="14" width="52" height="4" rx="2" fill="rgba(125,211,252,.55)"/><rect x="34" y="46" width="24" height="14" rx="7" fill="rgba(125,211,252,.25)"/></svg>`,
      lateral: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><circle cx="46" cy="18" r="6" fill="rgba(232,238,247,.7)"/><rect x="18" y="30" width="56" height="4" rx="2" fill="rgba(125,211,252,.55)"/><rect x="34" y="48" width="24" height="14" rx="7" fill="rgba(125,211,252,.25)"/></svg>`,
      row: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><rect x="10" y="54" width="72" height="5" rx="2.5" fill="rgba(125,211,252,.35)"/><circle cx="40" cy="28" r="5" fill="rgba(232,238,247,.7)"/><rect x="44" y="38" width="22" height="4" rx="2" fill="rgba(232,238,247,.35)"/></svg>`,
      curl: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><circle cx="46" cy="16" r="6" fill="rgba(232,238,247,.7)"/><rect x="22" y="28" width="48" height="8" rx="4" fill="rgba(125,211,252,.25)"/><rect x="34" y="46" width="24" height="14" rx="7" fill="rgba(125,211,252,.25)"/></svg>`,
      band: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><path d="M18 44 C30 34, 62 34, 74 44" fill="none" stroke="rgba(125,211,252,.55)" stroke-width="4" stroke-linecap="round"/><circle cx="46" cy="20" r="6" fill="rgba(232,238,247,.7)"/></svg>`,
      squat: () => `<svg viewBox="0 0 92 72" xmlns="http://www.w3.org/2000/svg"><rect x="16" y="18" width="60" height="4" rx="2" fill="rgba(125,211,252,.55)"/><circle cx="46" cy="24" r="6" fill="rgba(232,238,247,.7)"/><rect x="30" y="40" width="32" height="10" rx="5" fill="rgba(232,238,247,.35)"/></svg>`
    };

    // FULL Library (meer oefeningen)
    const LIB = {
      // PUSH
      db_bench: { name:"Dumbbell Bench Press", muscles:"Borst • triceps • schouders", equipment:"DB + bank", thumb: SVG.bench,
        tips:["Schouderbladen naar achter/beneden.","Elleboog 30–60° van je romp.","Rustig omlaag, krachtig omhoog."] },
      db_incline: { name:"Incline Dumbbell Press", muscles:"Bovenborst • schouders", equipment:"DB + bank", thumb: SVG.incline,
        tips:["Bank ~20–35°.","Polsen boven ellebogen.","Stop vóór schouders naar voren rollen."] },
      db_floor_press: { name:"Dumbbell Floor Press", muscles:"Borst • triceps", equipment:"DB", thumb: SVG.bench,
        tips:["Elleboog tikt vloer licht.","Top: knijp borst.","Veilig voor schouders."] },
      pushup: { name:"Push-up (band opt.)", muscles:"Borst • triceps • core", equipment:"BW/band", thumb: SVG.bench,
        tips:["Lichaam in 1 lijn.","Borst naar vloer.","Band voor extra weerstand."] },
      db_shoulder_press: { name:"Dumbbell Shoulder Press", muscles:"Schouders • triceps", equipment:"DB", thumb: SVG.press,
        tips:["Core strak, ribben omlaag.","Druk zonder shrug.","Langzaam omlaag."] },
      arnold_press: { name:"Arnold Press", muscles:"Schouders", equipment:"DB", thumb: SVG.press,
        tips:["Draai gecontroleerd.","Niet te zwaar.","Volledige ROM."] },
      lateral_raise: { name:"Lateral Raise", muscles:"Zijkant schouder", equipment:"DB/band", thumb: SVG.lateral,
        tips:["Licht gewicht, 12–20 reps.","Kleine elleboogbuiging.","Stop rond schouderhoogte."] },
      front_raise: { name:"Front Raise", muscles:"Voor schouder", equipment:"DB/band", thumb: SVG.lateral,
        tips:["Niet swingen.","1 sec pause bovenin.","Combineer met lateral raise."] },
      skullcrusher: { name:"Skull Crushers", muscles:"Triceps", equipment:"DB + bank", thumb: SVG.press,
        tips:["Elleboog omhoog.","Stretch achter het hoofd.","Controle > ego."] },
      triceps_overhead: { name:"Overhead Triceps Extension", muscles:"Triceps", equipment:"DB", thumb: SVG.press,
        tips:["Elleboog smal.","Volledige stretch.","Rustig tempo."] },
      close_grip_press: { name:"Close-Grip DB Press", muscles:"Triceps • borst", equipment:"DB + bank", thumb: SVG.bench,
        tips:["DB’s dicht bij elkaar.","Elleboog langs romp.","Top: triceps knijpen."] },

      // PULL
      one_arm_row: { name:"One-Arm Dumbbell Row", muscles:"Rug • biceps", equipment:"DB + bank", thumb: SVG.row,
        tips:["Heupen stil.","Elleboog richting heup.","1 sec squeeze bovenin."] },
      chest_supported_row: { name:"Chest-Supported DB Row", muscles:"Bovenrug", equipment:"DB + bank", thumb: SVG.row,
        tips:["Bank schuin.","Borst op bank.","Trek naar heupen."] },
      db_rdl: { name:"Dumbbell RDL", muscles:"Hamstrings • billen • onderrug", equipment:"DB", thumb: SVG.squat,
        tips:["Heupen naar achter.","Rug neutraal.","Voel stretch hamstrings."] },
      band_row: { name:"Band Row", muscles:"Rug", equipment:"Band", thumb: SVG.band,
        tips:["Span band stevig.","Elleboog naar achter.","Squeeze 1 sec."] },
      band_facepull: { name:"Band Face Pull", muscles:"Achter schouder • bovenrug", equipment:"Band", thumb: SVG.band,
        tips:["Trek naar neus/voorhoofd.","Elleboog hoog.","1 sec vasthouden."] },
      band_pulldown: { name:"Band Lat Pulldown (kniel)", muscles:"Lats", equipment:"Band", thumb: SVG.band,
        tips:["Kniel, band hoog vast.","Trek elleboog naar heup.","Geen shrug."] },
      bicep_curl: { name:"Dumbbell Bicep Curl", muscles:"Biceps", equipment:"DB", thumb: SVG.curl,
        tips:["Elleboog naast romp.","Volledige ROM.","2–3 sec omlaag."] },
      hammer_curl: { name:"Hammer Curl", muscles:"Biceps • brachialis", equipment:"DB", thumb: SVG.curl,
        tips:["Neutrale greep.","Controle.","Top voor ‘dikke’ armen."] },
      incline_curl: { name:"Incline DB Curl", muscles:"Biceps (lange kop)", equipment:"DB + bank", thumb: SVG.incline,
        tips:["Bank licht schuin.","Elleboog achter je romp.","Geen swing."] },
      rear_delt_fly: { name:"Rear Delt Fly", muscles:"Achter schouder", equipment:"DB/band", thumb: SVG.lateral,
        tips:["Heup-hinge.","Elleboog licht gebogen.","Squeeze achter schouder."] },

      // LEGS + CORE
      goblet_squat: { name:"Goblet Squat", muscles:"Benen • core", equipment:"DB", thumb: SVG.squat,
        tips:["Knieën volgen tenen.","Borst trots.","Diep zolang rug neutraal."] },
      split_squat: { name:"Bulgarian Split Squat", muscles:"Quads • billen", equipment:"DB + bank", thumb: SVG.squat,
        tips:["Achtervoet op bank.","Langzaam zakken.","Voorste voet stabiel."] },
      reverse_lunge: { name:"Reverse Lunge", muscles:"Quads • billen", equipment:"DB", thumb: SVG.squat,
        tips:["Stap achteruit.","Voorste knie stabiel.","Duw via voorste hiel."] },
      hip_thrust: { name:"Hip Thrust (DB)", muscles:"Billen", equipment:"DB + bank", thumb: SVG.bench,
        tips:["Kin licht in.","Top: 1 sec knijpen.","Ribben omlaag."] },
      calf_raise: { name:"Calf Raise", muscles:"Kuiten", equipment:"DB", thumb: SVG.squat,
        tips:["Volledige stretch onderin.","1 sec pauze bovenin.","12–20 reps."] },
      plank: { name:"Plank", muscles:"Core", equipment:"BW", thumb: SVG.band,
        tips:["Billen niet omhoog.","Ribben omlaag.","Adem rustig."] },
      deadbug: { name:"Dead Bug", muscles:"Core", equipment:"BW", thumb: SVG.band,
        tips:["Onder rug licht in vloer.","Langzaam.","Controle boven snelheid."] },
    };

    // TEMPLATES (gevuld)
    const TEMPLATES = {
      push: [
        "db_bench",
        "db_incline",
        "db_shoulder_press",
        "lateral_raise",
        "skullcrusher",
        "band_facepull"
      ],
      pull: [
        "one_arm_row",
        "chest_supported_row",
        "rear_delt_fly",
        "band_facepull",
        "bicep_curl",
        "hammer_curl"
      ],
      legs: [
        "goblet_squat",
        "db_rdl",
        "split_squat",
        "hip_thrust",
        "calf_raise",
        "plank"
      ]
    };

    // Sets
    function addSet(setsEl, preset){
      const node = setTemplate.content.firstElementChild.cloneNode(true);
      if (preset){
        node.querySelector(".reps").value = preset.reps ?? "";
        node.querySelector(".weight").value = preset.weight ?? "";
        node.querySelector(".rpe").value = preset.rpe ?? "";
      }
      node.querySelector(".removeSet").addEventListener("click", () => node.remove());
      setsEl.appendChild(node);
    }

    // Best set + volume
    function bestSet(sets){
      let best = null;
      for (const s of sets){
        const w = s.weight ?? null, r = s.reps ?? null;
        if (w === null && r === null) continue;
        if (!best){ best = s; continue; }
        const bw = best.weight ?? 0, br = best.reps ?? 0;
        const nw = w ?? 0, nr = r ?? 0;
        if (nw > bw || (nw === bw && nr > br)) best = s;
      }
      return best;
    }
    function setVolume(s){
      const w = s.weight ?? null, r = s.reps ?? null;
      if (w === null || r === null) return 0;
      return w * r;
    }
    function exerciseVolume(ex){
      return (ex.sets||[]).reduce((sum, s) => sum + setVolume(s), 0);
    }

    // Find last snapshot by name
    function findLastExerciseSnapshotByName(name, sessions){
      const key = (name||"").trim().toLowerCase();
      if (!key) return null;
      const desc = [...sessions].sort((a,b) => (b.date||"").localeCompare(a.date||""));
      for (const s of desc){
        for (const ex of (s.exercises||[])){
          if ((ex.name||"").trim().toLowerCase() === key){
            return { name: ex.name, sets: (ex.sets||[]).map(x => ({...x})) };
          }
        }
      }
      return null;
    }

    // Compare UI
    function formatBestSet(set){
      if (!set) return "—";
      const w = set.weight ?? null, r = set.reps ?? null;
      if (w === null && r === null) return "—";
      return `${w ?? ""}kg×${r ?? ""}`;
    }
    function bestSetScore(set){
      if (!set) return { w:0, r:0 };
      return { w:(set.weight ?? 0), r:(set.reps ?? 0) };
    }
    function diffLabel(cur, prev, decimals=0){
      const d = cur - prev;
      const sign = d > 0 ? "+" : "";
      const val = decimals ? d.toFixed(decimals) : String(Math.round(d));
      if (d > 0) return { cls:"up", text:`${sign}${val}` };
      if (d < 0) return { cls:"down", text:`${val}` };
      return { cls:"flat", text:"0" };
    }
    function compareHtml(prevSnap, currentEx){
      const prevBest = prevSnap ? bestSet(prevSnap.sets || []) : null;
      const curBest = bestSet(currentEx.sets || []);
      const prevVol = prevSnap ? exerciseVolume(prevSnap) : 0;
      const curVol = exerciseVolume(currentEx);

      const prevScore = bestSetScore(prevBest);
      const curScore = bestSetScore(curBest);

      const dW = diffLabel(curScore.w, prevScore.w, 1);
      const dR = diffLabel(curScore.r, prevScore.r, 0);
      const dV = diffLabel(curVol, prevVol, 0);

      return `
        <div><b>Vorige keer vs Nu</b></div>
        <div class="compareGrid">
          <div class="compareCard">
            <b>Vorige keer</b>
            <div>${prevSnap ? formatBestSet(prevBest) : "—"}</div>
            <div class="hint" style="margin-top:4px;">Vol: ${prevSnap ? Math.round(prevVol) : "—"}</div>
          </div>
          <div class="compareCard">
            <b>Nu</b>
            <div>${formatBestSet(curBest)}</div>
            <div class="hint" style="margin-top:4px;">Vol: ${Math.round(curVol)}</div>
          </div>
          <div class="compareCard">
            <b>Verschil</b>
            <div>kg: <span class="${dW.cls}">${dW.text}</span></div>
            <div>reps: <span class="${dR.cls}">${dR.text}</span></div>
            <div>vol: <span class="${dV.cls}">${dV.text}</span></div>
          </div>
        </div>
      `;
    }

    // Render exercise card
    function addExerciseCard(exId){
      const ex = LIB[exId];
      if (!ex) return;

      const sessions = loadSessions();
      const prevSnap = findLastExerciseSnapshotByName(ex.name, sessions);

      const node = exerciseTemplate.content.firstElementChild.cloneNode(true);
      const thumb = node.querySelector("[data-thumb]");
      const title = node.querySelector("[data-title]");
      const muscles = node.querySelector("[data-muscles]");
      const equipment = node.querySelector("[data-equipment]");
      const tipsEl = node.querySelector("[data-tips]");
      const compareEl = node.querySelector("[data-compare]");
      const setsEl = node.querySelector("[data-sets]");

      thumb.innerHTML = ex.thumb ? ex.thumb() : "";
      title.textContent = ex.name;
      muscles.textContent = ex.muscles;
      equipment.textContent = ex.equipment;

      tipsEl.innerHTML = `<div><b>Uitleg</b></div><ul>${(ex.tips||[]).map(t => `<li>${escapeHtml(t)}</li>`).join("")}</ul>`;

      const initialSets = (prevSnap?.sets?.length ? prevSnap.sets : [{},{},{}]);
      for (const s of initialSets) addSet(setsEl, s);

      function readCurrent(){
        const sets = [];
        setsEl.querySelectorAll(".setRow").forEach(row => {
          const reps = parseNum(row.querySelector(".reps").value);
          const weight = parseNum(row.querySelector(".weight").value);
          const rpe = parseNum(row.querySelector(".rpe").value);
          if (reps === null && weight === null && rpe === null) return;
          sets.push({ reps, weight, rpe });
        });
        return { sets };
      }

      compareEl.innerHTML = compareHtml(prevSnap, { sets: initialSets.map(x=>({ ...x })) });

      const rerender = () => { compareEl.innerHTML = compareHtml(prevSnap, readCurrent()); };
      setsEl.addEventListener("input", rerender);
      setsEl.addEventListener("change", rerender);

      node.querySelector("[data-addset]").addEventListener("click", () => {
        addSet(setsEl, {});
        setsEl.dispatchEvent(new Event("change"));
      });
      node.querySelector("[data-remove]").addEventListener("click", () => node.remove());

      exercisesWrap.appendChild(node);
    }

    function loadTemplate(key){
      exercisesWrap.innerHTML = "";
      const ids = TEMPLATES[key] || [];
      if (!ids.length){
        exercisesWrap.innerHTML = `<div class="warn">Geen template gevonden voor: <b>${escapeHtml(key)}</b></div>`;
        return;
      }
      ids.forEach(addExerciseCard);
    }

    function collectExercises(){
      const out = [];
      exercisesWrap.querySelectorAll(".exercise").forEach(exNode => {
        const name = exNode.querySelector("[data-title]")?.textContent?.trim() || "";
        if (!name) return;

        const sets = [];
        exNode.querySelectorAll(".setRow").forEach(row => {
          const reps = parseNum(row.querySelector(".reps").value);
          const weight = parseNum(row.querySelector(".weight").value);
          const rpe = parseNum(row.querySelector(".rpe").value);
          if (reps === null && weight === null && rpe === null) return;
          sets.push({ reps, weight, rpe });
        });

        out.push({ name, sets });
      });
      return out;
    }

    function renderLog(){
      const sessions = loadSessions().sort((a,b) => (b.date||"").localeCompare(a.date||""));
      if (!sessions.length){ logEl.textContent = "Nog geen trainingen."; return; }
      logEl.innerHTML = sessions.slice(0,12).map(s => {
        const summary = (s.exercises||[]).map(e => e.name).join(", ");
        return `<div style="margin:8px 0;">
          <b>${escapeHtml(s.date)}</b> — ${escapeHtml((s.template||"").toUpperCase())}<br>
          <span class="hint">${escapeHtml(summary)}</span>
        </div>`;
      }).join("");
    }

    // Export/Import
    exportBtn.addEventListener("click", () => {
      const sessions = loadSessions();
      const blob = new Blob([JSON.stringify(sessions, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `training-log-export-${todayISO()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", () => importFile.click());
    importFile.addEventListener("change", async () => {
      const file = importFile.files?.[0];
      if (!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error("bad");
        saveSessions(data);
        renderLog();
        alert("Import gelukt ✅");
      }catch{
        alert("Import mislukt (JSON).");
      }finally{
        importFile.value = "";
      }
    });

    // Events
    templateSelect.addEventListener("change", () => loadTemplate(templateSelect.value));
    reloadBtn.addEventListener("click", () => loadTemplate(templateSelect.value));
    clearFormBtn.addEventListener("click", () => {
      sessionNotesEl.value = "";
      loadTemplate(templateSelect.value);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    sessionForm.addEventListener("submit", (ev) => {
      ev.preventDefault();
      const date = dateEl.value;
      const template = templateSelect.value;
      if (!date) return;

      const exercises = collectExercises();
      if (!exercises.length){
        alert("Geen oefeningen geladen. Kies Push/Pull/Benen.");
        return;
      }

      const sessions = loadSessions();
      sessions.push({ id: uuid(), date, template, notes: (sessionNotesEl.value||"").trim(), exercises });
      saveSessions(sessions);
      renderLog();
      alert("Opgeslagen ✅");
    });

    // Init
    dateEl.value = todayISO();
    loadTemplate(templateSelect.value);
    renderLog();
  </script>
</body>
</html>
